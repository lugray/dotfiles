#!/usr/bin/ruby

require 'open3'

FIELD_SEP = "\u2007"

# fzf doesn't search undisplayed fields, so we add a bunch of padding to hide the additional search terms
PADDING = ' ' * 100

PREVIEW_PROGRAM = <<~PREVIEW
  echo -n "\e[96;4m"{2}"\e[0m";
  timeout 0.3 git-line {1} 2> /dev/null || echo "";
  echo "";
  bat --color=always {1}/README.md 2> /dev/null || cat {1}/README.md 2> /dev/null || ls --color=always {1}
PREVIEW

io = IO.popen(['fzf', '-d', FIELD_SEP, '--nth', '2..', '--with-nth', '2..', '--preview', PREVIEW_PROGRAM, '--no-hscroll', '--ellipsis', ''], 'r+')
# Fields: dir, name, additional search terms
Dir.glob("#{ENV['HOME']}/src/*/*/*").each do |dir|
  repo = File.basename(dir)
  org = File.basename(File.dirname(dir))
  additional = if org != 'Shopify'
    "#{org}/#{repo}"
  else
    "#{repo}" # fzf doesn't like a variable number of fields, so we repeat the repo name
  end
  io.write("#{dir}#{FIELD_SEP}#{repo}#{FIELD_SEP}#{PADDING}#{additional}\n")
end
io.write("#{ENV['HOME']}#{FIELD_SEP}~#{FIELD_SEP}#{PADDING}`~#{ENV['HOME']}home\n")
io.close_write
dir, name, _ = io.read.chomp.split(FIELD_SEP)
Process.wait(io.pid)
stat = $?
exit stat.exitstatus unless stat.success?

_, _, stat = Open3.capture3('kitty', '@', 'focus-tab', '--match', "title:^#{name}$")

unless stat.success?
  Open3.capture3('kitty', '@', 'launch', "--cwd=#{dir}", '--type=tab', "--tab-title=#{name}")
end
